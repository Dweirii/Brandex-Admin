generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Billboard {
  id        String     @id
  storeId   String
  label     String
  imageUrl  String
  createdAt DateTime   @default(now())
  updatedAt DateTime
  Store     Store      @relation(fields: [storeId], references: [id])
  Category  Category[]
}

model Category {
  id          String     @id
  storeId     String
  billboardId String
  name        String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  Billboard   Billboard  @relation(fields: [billboardId], references: [id])
  Store       Store      @relation(fields: [storeId], references: [id])
  products    products[]
}

model Image {
  id        String   @id
  productId String
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Order {
  id              String      @id
  userId          String?
  storeId         String
  isPaid          Boolean     @default(false)
  email           String?
  price           Decimal?    @default(0.00)
  phone           String?
  address         String?
  sessionId       String?     @default("")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime
  sessionVerified Boolean     @default(false)
  paymentProvider String?
  transactionId   String?
  Store           Store       @relation(fields: [storeId], references: [id])
  OrderItem       OrderItem[]
}

model OrderItem {
  id        String   @id
  orderId   String
  productId String
  price     Decimal? @default(0.00)
  Order     Order    @relation(fields: [orderId], references: [id])
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Store {
  id                  String                @id
  name                String
  userId              String
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  Billboard           Billboard[]
  Category            Category[]
  Order               Order[]
  downloads           downloads[]
  product_import_logs product_import_logs[]
  products            products[]
  subscriptions       subscriptions[]
}

model downloads {
  id        String   @id
  productId String
  storeId   String
  userId    String?
  email     String?
  isFree    Boolean  @default(true)
  createdAt DateTime @default(now())
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)
  Store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isFree])
  @@index([productId])
  @@index([storeId])
}

model product_import_logs {
  id               String       @id
  storeId          String
  userId           String
  fileName         String
  keywords         String[]     @default([])
  fileSize         Int          @default(0)
  totalRows        Int
  processedRows    Int?         @default(0)
  failedRows       Int?         @default(0)
  status           ImportStatus @default(PROCESSING)
  errorMessage     String?
  processingTimeMs Int?
  createdAt        DateTime     @default(now())
  startedAt        DateTime?
  completedAt      DateTime?
  metadata         Json?
  Store            Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([storeId])
  @@index([userId])
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model products {
  id             String      @id
  storeId        String
  categoryId     String
  name           String
  description    String?
  price          Decimal
  downloadUrl    String?
  keywords       String[]    @default([])
  isFeatured     Boolean     @default(false)
  isArchived     Boolean     @default(false)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime
  videoUrl       String?
  downloadsCount Int         @default(0)
  Image          Image[]
  OrderItem      OrderItem[]
  downloads      downloads[]
  Category       Category    @relation(fields: [categoryId], references: [id])
  Store          Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, name])
  @@index([categoryId])
  @@index([createdAt])
  @@index([isArchived])
  @@index([isFeatured])
  @@index([storeId])
}

model subscriptions {
  id                   String             @id
  userId               String
  storeId              String
  stripeSubscriptionId String?            @unique
  stripeCustomerId     String?            @unique
  status               SubscriptionStatus @default(INCOMPLETE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  trialStart           DateTime?
  trialEnd             DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  Store                Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([userId, storeId])
  @@index([status])
  @@index([storeId])
  @@index([stripeSubscriptionId])
  @@index([userId])
}

enum ImportStatus {
  PROCESSING
  COMPLETED
  COMPLETED_WITH_ERRORS
  FAILED
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  TRIALING
  INCOMPLETE
}
